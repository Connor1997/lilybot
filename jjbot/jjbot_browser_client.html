<!-- Joshwa -->
<!-- http://www.dexterindustries.com/   -->
<!-- Control of robot by a web browser using web sockets connection  -  client code -->
<!-- This code implements the web socket connection between client(web page) and a server(client-raspberry pi) -->
<!-- This code sends data from web page using buttons and Keyboard presses to control the robot-->

<!DOCTYPE html>
<html>
<head>
  <title>WebSockets Client</title>  
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  
  <style>
    .button {
      height: 100px; 
      width: 100px; 
    }

    #primary {
      width:50%;
      float:left;
    }

    #secondary{
      width:49%;
      float:right;
    }

    #log {
      height:400px;
      background-color: #000000;
      color:#00DD00;
      overflow:auto;
    }

    .padded {
      padding:5px;
    }
  </style>

</head>
<body>
<div id="content">
  <div id="primary">
    
    <div id="send">
      <p>  Enter the hostname/ip address to make the websocket connection </p>
      <input type="text" id="hostname" value="192.168.1.140"/>
      <input id="connect-btn" type="button" value="Connect &raquo;" onclick="setup2()" />
    </div>

    <div id="controls">
      <div>               
        <input class="button" type="button" value="-" disabled />                            
        <input class="button" type="button" value="Accelerate" onclick="accelerate(); " />
        <input class="button" type="button" value="-" disabled/>
      </div>

      <div>                                        
        <input class="button" type="button" value="Steer Left" onclick="steer_left(); " />
        <input class="button" type="button" value="Stop" onclick="stop(); " />
        <input class="button" type="button" value="Steer Right" onclick="steer_right(); " />
      </div>

      <div>
        <input class="button" type="button" value="-" disabled />
        <input class="button" type="button" value="Reverse" onclick="reverse(); " />
        <input class="button" type="button" value="-" disabled />
      </div>
    </div>
    <div>
      <p><span style="font-weight:bold">Instructions for keyboard controls:</span></p>    
      <p>Press Up arrow key - Acceleraate </p>
      <p>Press Down arrow key - Reverse </p>
      <p>Press Right arrow key - Steer Right</p>
      <p>Press Left arrow key - Steer Left</p>
      <p>Press cltr/shift key to Stop</p>
    </div>
  </div>

  <div id="secondary">
    <div id="log" class="padded">
    
    <div id="output"></div>
  </div> <!-- End .secondary -->
</div><!-- end content -->



<script>
var up;
var down;
var left;
var right;
var brakes;
function accelerate()       // defines a variable that controls the forward movement
{
    up = "u";               // when up == u the bot moves forward 
    down = "aaa";left = "aaa";right = "aaa";brakes = "aaa";       // When up button is pressed other buttons(variables) should be turned off.
    setup2();        // Goes to websocket connection function
}  

function reverse(){
    down = "d";
    up = "aaa";left = "aaa";right = "aaa";brakes = "aaa";
    setup2();
}

function steer_left(){
    left = "l";
    up = "aaa";down = "aaa";right = "aaa";brakes = "aaa";
    setup2();
}

function steer_right(){
    right = "r";
    up = "aaa";down = "aaa";left = "aaa";brakes = "aaa";
    setup2();
}

function stop(){
    up = "aaa";down = "aaa";left = "aaa";right = "aaa";brakes = "b";
    setup2();
}        

function setup2(){
    // Creates the websocets connection{
    var $txt = $("#hostname");      // assigns the hostname(hostname/ip address) entered in the text box
    name = $txt.val();          // Variable name contains the string(hostname/ip address) entered in the text box
    var host =  "ws://"+name+":9093/ws";      // combines the three string and creates a new string
    var socket = new WebSocket(host);
    var $btnSend = $("#sendtext");
    $txt.focus();
    // event handlers for UI

    $btnSend.on('click',function(){
      var text = $txt.val();
        if(text == ""){
         return;
        }
        $txt.val("");
      }); 
      $txt.keypress(function(evt){
          if(evt.which == 13) $btnSend.click();
      });

    // event handlers for websocket
    if(socket){
        var count =1;
        socket.onopen = function(){
            count = 0;
            //alert("connection opened....");
            arrows();     // function for detecting keyboard presses
            buttons();    // function for detecting the button press on webpage
    }
    
  function buttons() { 
    if(up== "u") {
      socket.send("u");
    }   
    
    if(down== "d") {
      socket.send("d");
    }
    
    if(left== "l") {
      socket.send("l");
    }   
    
    if(right== "r") {
      socket.send("r");
    }   
    
    if(brakes == "b") {
      socket.send("b");
    }
  }

  function arrows() {
    document.onkeyup = KeyCheck;       
    function KeyCheck(){
       var KeyID = event.keyCode;
       switch(KeyID)
       {
            case 16:
            socket.send("b");
            break; 
            case 17:
            socket.send("b");
            break;
            case 37:
            socket.send("l");
            break;
            case 38:
            socket.send("u");
            break;
            case 39:
            socket.send("r");
            break;
            case 40:
            socket.send("d");
            break;
       }
    }
  }

     socket.onmessage = function(msg)
     {
        showServerResponse(msg.data);
     }

     socket.onclose = function(){
        //alert("connection closed....");
        showServerResponse("The connection has been closed.");
     }

    }
    
    else
    {
      console.log("invalid socket");
    }

    function showServerResponse(txt){
        $log = $("#log");
        $newRow = $("<div>");
        $newRow.text(txt);
        $log.append($newRow);
        $log.scrollTop($log[0].scrollHeight);
    }   
        
}   

</script>
</body>
</html>
<script>   

jQuery(function($)
{
  if (!("WebSocket" in window)) 
  {
    alert("Your browser does not support web sockets");
  }
});

</script>